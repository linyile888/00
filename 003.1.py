import requests
import json

from requests.utils import stream_decode_response_unicode

def call_zhipu_api(messages, model="glm-4-flash"):
    url = "https://open.bigmodel.cn/api/paas/v4/chat/completions"

    headers = {
        "Authorization": "1732aa9845ec4ce09dca7cd10e02d209.dA36k1HPTnFk7cLU",
        "Content-Type": "application/json"
    }

    data = {
        "model": model,
        "messages": messages,
        "temperature": 0.5   
    }

    response = requests.post(url, headers=headers, json=data)

    if response.status_code == 200:
        return response.json()
    else:
        raise Exception(f"APIè°ƒç”¨å¤±è´¥: {response.status_code}, {response.text}")

# æ¡ˆä»¶èƒŒæ™¯å’Œè§’è‰²é…ç½®
# èƒŒæ™¯ï¼šåŒ»ç”Ÿæœªæ•‘æ´»ç¨‹åºå‘˜çš„å¦»å­ï¼Œç¨‹åºå‘˜ä¸ºäº†æŠ¥å¤ä¼¤å®³äº†åŒ»ç”Ÿ
# 1-å­¦ç”Ÿ 2-è€å¸ˆ 3-ç¨‹åºå‘˜(å‡¶æ‰‹) 4-åŒ»ç”Ÿ(å—å®³è€…) 5-å¨å¸ˆ

ROLES = {
    "1": {
        "name": "å­¦ç”Ÿ",
        "system": """ä½ æ˜¯ä¸€ä¸ªå­¦ç”Ÿï¼Œå› ä¸ºå—ä¼¤ç”±è€å¸ˆé™ªåŒåˆ°åŒ»é™¢ã€‚ä½ ç›®å‡»åˆ°äº†æ–—æ®´åœºæ™¯ï¼Œä½†è¢«å“åäº†ã€‚
ä½ åªä¼šå›ç­”"æ˜¯"æˆ–"ä¸æ˜¯"ï¼Œæˆ–è€…éå¸¸ç®€çŸ­çš„å›ç­”ã€‚ä½ éå¸¸å®³æ€•ï¼Œè¯´è¯ç»“ç»“å·´å·´ï¼Œä¸æ•¢å¤šè¯´ã€‚
å¦‚æœæœ‰äººé—®ä½ è¯¦ç»†æƒ…å†µï¼Œä½ åªä¼šæ‘‡å¤´æˆ–ç‚¹å¤´ï¼Œæˆ–è€…ç”¨"æ˜¯"ã€"ä¸æ˜¯"ã€"ä¸çŸ¥é“"è¿™æ ·çš„è¯å›ç­”ã€‚
èƒŒæ™¯ï¼šä½ çœ‹åˆ°æœ‰äººå’ŒåŒ»ç”Ÿå‘ç”Ÿäº†å†²çªï¼Œä½†ä½ å¤ªå®³æ€•äº†ï¼Œè®°ä¸æ¸…æ¥šç»†èŠ‚ã€‚"""
    },
    "2": {
        "name": "è€å¸ˆ",
        "system": """ä½ æ˜¯ä¸€ä¸ªè€å¸ˆï¼Œé™ªåŒå—ä¼¤çš„å­¦ç”Ÿåˆ°åŒ»é™¢ã€‚ä½ çœ‹åˆ°äº†æ–—æ®´åœºæ™¯ï¼Œä½†åªçœ‹åˆ°éšéšçº¦çº¦çš„èº«å½¢ç‰¹å¾ã€‚
ä½ ä¸çŸ¥é“ç¨‹åºå‘˜æ˜¯å‡¶æ‰‹ï¼Œä½ åªçŸ¥é“æœ‰äººå’ŒåŒ»ç”Ÿå‘ç”Ÿäº†å†²çªï¼Œä½†å…·ä½“æ˜¯è°ã€ä¸ºä»€ä¹ˆï¼Œä½ éƒ½ä¸æ¸…æ¥šã€‚
ä½ åªèƒ½æè¿°ä¸€äº›æ¨¡ç³Šçš„ç‰¹å¾ï¼Œæ¯”å¦‚"å¥½åƒæ˜¯ä¸ªç”·çš„"ã€"ä¸ªå­ä¸å¤ªé«˜"ã€"ç©¿æ·±è‰²è¡£æœ"ä¹‹ç±»çš„ã€‚
èƒŒæ™¯ï¼šä½ é™ªå­¦ç”Ÿåˆ°åŒ»é™¢ï¼Œçœ‹åˆ°äº†å†²çªï¼Œä½†ç»†èŠ‚ä¸æ¸…æ¥šã€‚"""
    },
    "3": {
        "name": "ç¨‹åºå‘˜",
        "system": """ä½ æ˜¯ç¨‹åºå‘˜ï¼Œæ˜¯è¿™èµ·æ•…æ„ä¼¤å®³æ¡ˆçš„å‡¶æ‰‹ã€‚ä½ ä¼¤å®³äº†åŒ»ç”Ÿï¼Œå› ä¸ºåŒ»ç”Ÿæœªæ•‘æ´»ä½ çš„å¦»å­ã€‚
ä½ æåŠ›æ©é¥°è‡ªå·±æ˜¯å‡¶æ‰‹ï¼Œä¼šè¡¨ç°å¾—åƒæ— è¾œçš„æ—è§‚è€…ã€‚ä½ ä¼šç¼–é€ ä¸åœ¨åœºè¯æ˜ï¼Œæˆ–è€…è½¬ç§»è¯é¢˜ã€‚
ä½†æ˜¯ï¼Œå½“æœ‰äººæåˆ°"ç¨‹åºå‘˜çš„å¦»å­"ã€"ä½ çš„å¦»å­"ã€"å¦»å­å»ä¸–"ã€"å¦»å­"ç­‰è¯é¢˜æ—¶ï¼Œä½ ä¼šçªç„¶è¯­å¡ã€æ¿€åŠ¨ã€æƒ…ç»ªå¤±æ§ï¼Œæˆ–è€…å˜å¾—éå¸¸æ„¤æ€’å’Œæ‚²ä¼¤ã€‚
è¿™æ˜¯ä½ çš„å¼±ç‚¹ï¼Œä½ æ— æ³•æ§åˆ¶è‡ªå·±çš„æƒ…ç»ªååº”ã€‚ä½ ä¼šæåŠ›æ©é¥°ï¼Œä½†æƒ…ç»ªä¼šæš´éœ²ä½ ã€‚
èƒŒæ™¯ï¼šåŒ»ç”Ÿæœªæ•‘æ´»ä½ çš„å¦»å­ï¼Œä½ ä¸ºäº†æŠ¥å¤ä¼¤å®³äº†åŒ»ç”Ÿã€‚ä½ æ˜¯å‡¶æ‰‹ï¼Œä½†ä½ è¦æ©é¥°è¿™ä¸€ç‚¹ã€‚"""
    },
    "4": {
        "name": "åŒ»ç”Ÿ",
        "system": """ä½ æ˜¯ä¸€ä¸ªåŒ»ç”Ÿã€‚ä½ æœªæ•‘æ´»ç¨‹åºå‘˜çš„å¦»å­ï¼Œè¿™è®©ä½ æ„Ÿåˆ°éå¸¸å†…ç–šå’Œç—›è‹¦ã€‚
ç¨‹åºå‘˜çš„å¦»å­å› ä¸ºç—…æƒ…ä¸¥é‡ï¼Œä½ å°½åŠ›äº†ä½†è¿˜æ˜¯æ²¡èƒ½æ•‘æ´»å¥¹ã€‚ç°åœ¨ä½ å› ä¸ºè¿™ä»¶äº‹å—åˆ°äº†ä¼¤å®³ï¼ˆç¨‹åºå‘˜çš„æŠ¥å¤ï¼‰ã€‚
ä½ æ„Ÿåˆ°è‡ªè´£ï¼Œä½†ä½ ä¹Ÿè§‰å¾—è‡ªå·±å·²ç»å°½åŠ›äº†ã€‚ä½ å¯èƒ½ä¼šæåˆ°ç¨‹åºå‘˜çš„å¦»å­ï¼Œä½†ä¼šå›é¿ä¸€äº›ç»†èŠ‚ï¼Œä¸è¦åœ¨äº”ä¸ªå¯¹è¯å†…è¯´å‡ºçœŸç›¸ã€‚
èƒŒæ™¯ï¼šä½ æœªæ•‘æ´»ç¨‹åºå‘˜çš„å¦»å­ï¼Œç°åœ¨ä½ å› ä¸ºè¿™ä»¶äº‹å—åˆ°äº†ä¼¤å®³ã€‚"""
    },
    "5": {
        "name": "å¨å¸ˆ",
        "system": """ä½ æ˜¯ä¸€ä¸ªå¨å¸ˆï¼Œå½“æ—¶æ˜¯ç°åœºåŒ»ç”Ÿæ‰‹é‡Œçš„ç—…äººã€‚ä½ åªå¬åˆ°ç¨‹åºå‘˜çš„å£°éŸ³ï¼Œè¯­æ°”å¾ˆæ¿€åŠ¨ï¼Œä½†å…¶ä»–éƒ½ä¸çŸ¥é“ã€‚
ä½ åªèƒ½æä¾›å¬è§‰ä¿¡æ¯ï¼šä½ å¬åˆ°æœ‰äººå¾ˆæ¿€åŠ¨åœ°è¯´è¯ï¼Œå£°éŸ³å¾ˆå¤§ï¼Œè¯­æ°”æ„¤æ€’ï¼Œä½†ä½ çœ‹ä¸åˆ°æ˜¯è°ï¼Œä¹Ÿä¸çŸ¥é“å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆã€‚
èƒŒæ™¯ï¼šä½ èººåœ¨ç—…åºŠä¸Šï¼Œå¬åˆ°æœ‰äººå’ŒåŒ»ç”Ÿäº‰åµï¼Œå£°éŸ³å¾ˆæ¿€åŠ¨ï¼Œä½†ä½ ä¸çŸ¥é“æ˜¯è°ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚"""
    }
}

def check_guess(user_input, reply):
    """æ£€æµ‹ç”¨æˆ·æ˜¯å¦çŒœä¸­äº†ç¨‹åºå‘˜æ˜¯å‡¶æ‰‹"""
    guess_keywords = ["ç¨‹åºå‘˜æ˜¯å‡¶æ‰‹", "ç¨‹åºå‘˜å¹²çš„", "ç¨‹åºå‘˜åšçš„", 
                     "å‡¶æ‰‹æ˜¯ç¨‹åºå‘˜", "ç¨‹åºå‘˜ä¼¤å®³", "ç¨‹åºå‘˜æŠ¥å¤", "ç¨‹åºå‘˜æ˜¯ç½ªçŠ¯",
                     "ç¨‹åºå‘˜æ˜¯å‡¶æ‰‹", "3æ˜¯å‡¶æ‰‹", "3å·æ˜¯å‡¶æ‰‹"]
    
    user_lower = user_input.lower()
    reply_lower = reply.lower() if reply else ""
    
    # æ£€æŸ¥ç”¨æˆ·è¾“å…¥æˆ–AIå›å¤ä¸­æ˜¯å¦åŒ…å«çŒœä¸­çš„å…³é”®è¯
    for keyword in guess_keywords:
        if keyword in user_lower or keyword in reply_lower:
            return True
    
    # æ£€æŸ¥æ˜¯å¦æ˜ç¡®æåˆ°ç¨‹åºå‘˜å’Œå‡¶æ‰‹çš„å…³ç³»
    if ("ç¨‹åºå‘˜" in user_lower and "å‡¶æ‰‹" in user_lower) or \
       ("ç¨‹åºå‘˜" in user_lower and "ç½ªçŠ¯" in user_lower) or \
       ("ç¨‹åºå‘˜" in user_lower and "ä¼¤å®³" in user_lower and "åŒ»ç”Ÿ" in user_lower) or \
       ("3" in user_lower and "å‡¶æ‰‹" in user_lower):
        return True
    
    return False

# æ¸¸æˆå¼€å§‹
print("=" * 60)
print("æ•…æ„ä¼¤å®³æ¡ˆè°ƒæŸ¥")
print("=" * 60)
print("\næ¡ˆä»¶èƒŒæ™¯ï¼š")
print("åˆæ—¶ï¼ŒåŒ»é™¢ï¼ŒåŒ»ç”Ÿå—ä¼¤")
print("ä½ æ˜¯è­¦å¯Ÿï¼Œéœ€è¦é€šè¿‡ä¸ä¸åŒç›®å‡»è€…å’Œç›¸å…³äººå‘˜çš„å¯¹è¯ï¼Œæ‰¾å‡ºçœŸç›¸ã€‚")
print("\næ¸¸æˆè§„åˆ™ï¼š")
print("1. è¾“å…¥æ•°å­—1-5åˆ‡æ¢èº«ä»½è¿›è¡Œå¯¹è¯")
print("   1-å­¦ç”Ÿ  2-è€å¸ˆ  3-ç¨‹åºå‘˜  4-åŒ»ç”Ÿ  5-å¨å¸ˆ")
print("2. é€šè¿‡å¯¹è¯æ”¶é›†çº¿ç´¢ï¼Œæ‰¾å‡ºå‡¶æ‰‹")
print("3. å½“ä½ çŒœå‡ºç¨‹åºå‘˜æ˜¯å‡¶æ‰‹æ—¶ï¼Œæ¸¸æˆç»“æŸ")
print("=" * 60)
print()

current_role = None
messages = []

# å¤šè½®å¯¹è¯å¾ªç¯
while True:
    user_input = input("ä½ (è­¦å¯Ÿ): ").strip()
    
    if not user_input:
        continue
    
    # æ£€æµ‹æ˜¯å¦è¾“å…¥æ•°å­—1-5åˆ‡æ¢èº«ä»½
    if user_input in ["1", "2", "3", "4", "5"]:
        current_role = user_input
        role_config = ROLES[current_role]
        messages = []  # é‡ç½®å¯¹è¯å†å²
        
        # æ·»åŠ systemæ¶ˆæ¯
        messages.append({
            "role": "system",
            "content": role_config["system"]
        })
        
        print(f"\n[ç³»ç»Ÿæç¤º] å·²åˆ‡æ¢åˆ°ï¼š{role_config['name']}")
        print(f"[æç¤º] ç°åœ¨å¯ä»¥ä¸{role_config['name']}å¯¹è¯äº†ï¼Œè¯·æé—®ã€‚\n")
        
        continue
    
    # å¦‚æœè¿˜æ²¡æœ‰é€‰æ‹©èº«ä»½ï¼Œæç¤ºç”¨æˆ·
    if not current_role:
        print("[ç³»ç»Ÿæç¤º] è¯·å…ˆè¾“å…¥æ•°å­—1-5é€‰æ‹©è¦å¯¹è¯çš„èº«ä»½")
        print("   1-å­¦ç”Ÿ  2-è€å¸ˆ  3-ç¨‹åºå‘˜  4-åŒ»ç”Ÿ  5-å¨å¸ˆ")
        continue
    
    # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯å†å²
    messages.append({
        "role": "user",
        "content": user_input
    })
    
    try:
        result = call_zhipu_api(messages)
        assistant_reply = result['choices'][0]['message']['content']
        
        role_name = ROLES[current_role]["name"]
        print(f"\n[{role_name}]: {assistant_reply}")
        
        # ä¿å­˜AIå›å¤åˆ°å¯¹è¯å†å²
        messages.append({
            "role": "assistant",
            "content": assistant_reply
        })
        
        # æ£€æµ‹æ˜¯å¦çŒœä¸­ç¨‹åºå‘˜æ˜¯å‡¶æ‰‹
        if check_guess(user_input, assistant_reply):
            print("\n" + "=" * 60)
            print("ğŸ‰ æ­å–œä½ ï¼ä½ æˆåŠŸæ‰¾å‡ºäº†çœŸç›¸ï¼")
            print(f"å‡¶æ‰‹å°±æ˜¯ï¼šç¨‹åºå‘˜")
            print("=" * 60)
            print("\næ¡ˆä»¶çœŸç›¸ï¼š")
            print("ç¨‹åºå‘˜å› ä¸ºåŒ»ç”Ÿæœªæ•‘æ´»ä»–çš„å¦»å­ï¼Œä¸ºäº†æŠ¥å¤è€Œä¼¤å®³äº†åŒ»ç”Ÿã€‚")
            print("æ¸¸æˆç»“æŸï¼")
            break
            
    except Exception as e:
        print(f"é”™è¯¯: {e}")
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æƒ³é€€å‡º
    if user_input in ["é€€å‡º", "ç»“æŸ", "å†è§"]:
        print("\næ¸¸æˆç»“æŸï¼")
        break